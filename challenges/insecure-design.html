<div class="challenge-content">
    <h2>Insecure Design Challenge</h2>
    <p>A payment system has a critical design flaw. Exploit the race condition and business logic vulnerability to reveal the flag.</p>
    
    <div class="info-box">
        <strong>Challenge:</strong> The payment system has a critical race condition in its async transaction processing. The balance check and deduction are separate asynchronous operations with timing delays. By triggering multiple rapid purchases, you can exploit the timing window where checks pass before deductions occur. The flag is only revealed after successfully exploiting this vulnerability.
    </div>
    
    <div class="warning-box">
        <strong>Note:</strong> This challenge requires understanding of race conditions, async programming, and business logic vulnerabilities.
    </div>
    
    <h3>Payment System</h3>
    <div class="info-box">
        <p>You have a balance of <strong id="balance">100</strong> tokens.</p>
        <p>You need to purchase an item that costs <strong>150</strong> tokens.</p>
        <p>The system has a race condition - can you exploit it?</p>
    </div>
    
    <div class="flag-submission" style="margin-top: 2rem;">
        <h3>Actions</h3>
        <button class="btn-submit" onclick="makePurchase()">Purchase Item (150 tokens)</button>
        <button class="btn-submit" onclick="checkFlag()" style="margin-left: 1rem;">Check for Flag</button>
        <div id="purchase-result" class="mt-2"></div>
        <div id="flag-reveal" class="hidden mt-2"></div>
    </div>
    
    <h3>Flag Submission</h3>
    <div class="flag-submission">
        <div class="flag-input-group">
            <input type="text" id="flag-input" placeholder="CTF{...}" />
            <button class="btn-submit" id="submit-flag-btn">Submit</button>
        </div>
        <div id="flag-result" class="hidden"></div>
    </div>
    
    <div class="hints-section">
        <h3>Hints</h3>
        <div class="hint-item">
            <button class="hint-toggle" onclick="toggleHint('hint-1')">
                Hint 1 <span id="hint-1-arrow">▼</span>
            </button>
            <div id="hint-1" class="hint-content hidden">
                The balance check is async with a delay (50-100ms), and the deduction also has a delay (100-200ms). This creates a vulnerability window. If you trigger multiple purchases rapidly (within the window), multiple checks can pass before any deduction occurs. Use exploitRaceCondition() in console or rapidly click the button.
            </div>
        </div>
        <div class="hint-item">
            <button class="hint-toggle" onclick="toggleHint('hint-2')">
                Hint 2 <span id="hint-2-arrow">▼</span>
            </button>
            <div id="hint-2" class="hint-content hidden">
                The race condition allows multiple transactions to pass the balance check before any balance is actually deducted. You need to trigger enough purchases so that the balance goes negative or multiple transactions are pending. The flag will automatically reveal when the exploitation succeeds (balance < 0 or pendingTransactions.length > 1).
            </div>
        </div>
    </div>
</div>


